<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Task-Tracker with Time Tokens</title>
<style>
/* ---------- BASIC LAYOUT ---------- */
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f0f0f0;color:#222}
header,main,footer{max-width:1100px;margin:auto;padding:10px}
h1,h2,h3{margin:4px 0}
nav a{margin-right:10px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
td.task-completed{text-decoration:line-through;color:#888}
input[type=text],select{padding:4px}
button{padding:5px 8px;margin:2px;cursor:pointer}
.hidden{display:none}

/* ---------- LAYOUT SPLIT ---------- */
#task-sections{display:flex;gap:10px;margin-top:10px}
#daily-section{flex:3}
#weekly-section{flex:1;background:#fff;border:1px solid #bbb;padding:8px;border-radius:8px}

/* ---------- WEEKLY TOKEN BAR ---------- */
#token-week-wrapper{display:flex;align-items:center;margin-top:14px}
#token-week-text{min-width:160px;font-weight:bold}
.token-week-bar{flex:1;height:24px;background:#ddd;border-radius:6px;overflow:hidden;position:relative}
.token-week-fill{height:100%;background:#76c7c0;width:0%;transition:width .3s}
.token-week-fill.over{background:#d9534f}
.token-week-label{position:absolute;width:100%;text-align:center;line-height:24px;font-weight:bold;color:#fff}

/* ---------- PROGRESS BARS ---------- */
.progress-wrapper{display:flex;align-items:center;margin:8px 0}
.progress-label{min-width:90px;text-align:right;padding-right:6px;font-weight:bold}
.progress-bar{flex:1;height:20px;background:#e0e0e0;border-radius:5px;position:relative}
.progress-fill{background:#4287f5;height:100%;width:0%;transition:width .3s}
.progress-text{position:absolute;width:100%;text-align:center;line-height:20px;color:#fff;font-weight:bold}

/* ---------- FORMS ---------- */
.form-block{margin-top:20px;border:1px solid #bbb;background:#fff;padding:10px;border-radius:8px}
.form-block h3{margin-top:0}

/* ---------- UTILITY ---------- */
.flex{display:flex;align-items:center}
.mt10{margin-top:10px}
</style>
</head>
<body>
<header>
  <h1>Task Tracker (Å¦ / â‚± Edition)</h1>
  <nav>
    <a href="index.html">Home</a>
    <a href="#">Tasks</a>
    <button id="login" style="margin-left:20px">ðŸ”’ Log in to sync</button>
    <span id="login-status" style="margin-left:8px;font-weight:bold;color:#555">(offline)</span>
  </nav>
</header>

<main>
  <!-- WEEK TOKEN BAR -->
  <div id="token-week-wrapper">
    <span id="token-week-text">Å¦ Used: 0 / 0</span>
    <div class="token-week-bar">
      <div id="token-week-fill" class="token-week-fill"></div>
      <div id="token-week-label" class="token-week-label">0 %</div>
    </div>
  </div>

  <!-- POINT Tracking -->
  <div style="margin-top:10px;font-weight:bold;text-align:center;">
    Current Points (â‚±): <span id="points-current">0</span> | 
    Earned: <span id="points-earned">0</span> | 
    Spent: <span id="points-spent">0</span>
  </div>

  <!-- CALENDAR -->
  <div class="flex mt10">
    <button onclick="changeMonth(-1)">&#8249;</button>
    <h3 id="calendar-month-year" style="flex:1;text-align:center"></h3>
    <button onclick="changeMonth(1)">&#8250;</button>
  </div>
  <div id="calendar"></div>
  <h4>Date: <span id="date-today"></span></h4>

  <!-- SPLIT TASK SECTIONS -->
  <div id="task-sections">
    <!-- DAILY TASKS -->
    <div id="daily-section">
      <h3>Daily Tasks</h3>
      <table id="task-table"></table>
    </div>
    <!-- WEEKLY TASKS -->
    <div id="weekly-section">
      <h3 id="weekly-header">Weekly Tasks</h3>
      <table id="weekly-task-table"></table>
    </div>
  </div>

  <!-- CATEGORY WEEKLY SPENDING PROGRESS -->
  <div id="progress-container" class="mt10"></div>

  <!-- ADD TASK -->
  <div class="form-block">
    <h3>Add Task</h3>
    <input id="new-task-desc" type="text" placeholder="Task description">
    <select id="new-task-scope">
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
    </select>
    <select id="new-task-signif">
      <option value="daily">daily (0.2 Å¦/h)</option>
      <option value="minor">minor (0.5 Å¦/h)</option>
      <option value="major">major (1 Å¦/h)</option>
      <option value="massive">massive (2 Å¦/h)</option>
    </select>
    <select id="new-task-cat"></select>
    <button onclick="addTask()">Add</button>
  </div>

  <!-- ADD / REMOVE CATEGORY -->
  <div class="form-block flex">
    <div style="flex:1">
      <h3>Add Category</h3>
      <input id="new-cat-name" type="text" placeholder="Category">
      <button onclick="addCategory()">Add</button>
    </div>
    <div style="flex:1">
      <h3>Remove Category</h3>
      <select id="remove-cat-select"></select>
      <button onclick="removeCategory()">Delete</button>
    </div>
  </div>

  <!-- REWARD SHOP -->
  <div class="form-block">
    <h3 id="shop-title">Reward Shop (Choose category)</h3>
    <select id="shop-cat-select" onchange="renderShop()"></select>
    <div id="shop-list" class="mt10"></div>

    <h4 class="mt10">Add Reward to Category</h4>
    <input id="new-reward-desc" type="text" placeholder="Description">
    <input id="new-reward-cost" type="number" min="1" style="width:80px" placeholder="â‚±">
    <button onclick="addReward()">Add Reward</button>
  </div>

  <!-- SETTINGS -->
  <div class="form-block">
    <h3>Settings</h3>
    Weekly Å¦ Trove: <input id="weekly-tokens-input" type="number" style="width:80px">
    <button onclick="updateSettings()">Save</button>
  </div>

  <!-- CLEAR -->
  <div class="form-block">
    <button onclick="clearAllData()" style="background:#d9534f;color:#fff">Clear ALL local data</button>
  </div>

  <!-- BACKUP -->
  <div class="form-block">
    <button onclick="saveBackup()">Save Backup</button>
    <input type="file" id="loadBackup" onchange="loadBackup(event)" style="display:none;">
    <button onclick="document.getElementById('loadBackup').click()">Load Backup</button>
  </div>
</main>

<footer style="text-align:center;margin-top:30px">
  Â© 2025 Christian Kohnle
</footer>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MODULE SCRIPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script type="module">
/* imports ... (same as your version) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getAnalytics }  from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";
import { getAuth, signInWithPopup, signInWithRedirect, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

const firebaseConfig={/* ... your config unchanged ... */};
const fbApp=initializeApp(firebaseConfig);getAnalytics(fbApp);
const auth=getAuth(fbApp);const db=getFirestore(fbApp);

/* ---------- STATE ---------- */
const signifRate={daily:0.2,minor:0.5,major:1,massive:2};
let settings=JSON.parse(localStorage.getItem("settings"))||{weeklyTokens:80};
let pointsData=JSON.parse(localStorage.getItem("pointsData"))||{current:0,totalEarned:0,totalSpent:0};
let tasks=JSON.parse(localStorage.getItem("tasks"))||{};               // daily tasks
let weeklyTasks=JSON.parse(localStorage.getItem("weeklyTasks"))||{};   // NEW weekly tasks
let categories=JSON.parse(localStorage.getItem("categories"))||[{name:"General",rewards:[],cap:100}];
let tokenUsage=JSON.parse(localStorage.getItem("tokenUsage"))||{};

/* ---------- DATE HELPERS ---------- */
const fmtDate=d=>`${("0"+(d.getMonth()+1)).slice(-2)}-${("0"+d.getDate()).slice(-2)}-${d.getFullYear()}`;
function getWeekRange(dateStr){
  const [m,d,y]=dateStr.split("-").map(Number);
  const dt=new Date(`${y}-${m}-${d}`);dt.setHours(0,0,0,0);
  const day=dt.getDay();
  const sunday=new Date(dt);sunday.setDate(dt.getDate()-day);
  const saturday=new Date(sunday);saturday.setDate(sunday.getDate()+6);
  return `${fmtDate(sunday)} â€“ ${fmtDate(saturday)}`;
}
function weekId(dateStr){
  const [m,d,y]=dateStr.split("-").map(Number);
  const dt=new Date(`${y}-${m}-${d}`);dt.setHours(0,0,0,0);
  const sunday=new Date(dt);sunday.setDate(dt.getDate()-dt.getDay());
  return fmtDate(sunday); // weekId = sunday date
}

/* ---------- SAVE HELPERS ---------- */
function saveLocal(){
  localStorage.setItem("settings",JSON.stringify(settings));
  localStorage.setItem("pointsData",JSON.stringify(pointsData));
  localStorage.setItem("tasks",JSON.stringify(tasks));
  localStorage.setItem("weeklyTasks",JSON.stringify(weeklyTasks));
  localStorage.setItem("categories",JSON.stringify(categories));
  localStorage.setItem("tokenUsage",JSON.stringify(tokenUsage));
}
async function save(){
  saveLocal();
  if(!auth.currentUser) return;
  await setDoc(doc(db,"trackers",auth.currentUser.uid),{settings,pointsData,tasks,weeklyTasks,categories,tokenUsage,lastUpdated:new Date()},{merge:true});
}

/* ---------- RENDER ---------- */
function renderTaskTable(){
  const tBody=document.getElementById("task-table");
  tBody.innerHTML=`<tr><th>Task</th><th>Signif</th><th>Cat</th><th>Å¦/h</th><th>Done?</th><th>Del</th></tr>`;
  (tasks[selDate]||[]).forEach((t,i)=>{
    tBody.innerHTML+=`<tr>
      <td class="${t.done?"task-completed":""}">${t.desc}</td>
      <td>${t.signif}</td>
      <td>${t.cat}</td>
      <td>${signifRate[t.signif]}</td>
      <td><input type="checkbox" ${t.done?"checked":""} onchange="toggleDone('${selDate}',${i},'daily',this)"></td>
      <td><button onclick="delTask('${selDate}',${i},'daily')">x</button></td>
    </tr>`;
  });
}
function renderWeeklyTasks(){
  const wId=weekId(selDate);
  const header=document.getElementById("weekly-header");
  header.textContent=`Weekly Tasks (${getWeekRange(selDate)})`;
  const tBody=document.getElementById("weekly-task-table");
  tBody.innerHTML=`<tr><th>Task</th><th>Cat</th><th>Done?</th><th>Del</th></tr>`;
  (weeklyTasks[wId]||[]).forEach((t,i)=>{
    tBody.innerHTML+=`<tr>
      <td class="${t.done?"task-completed":""}">${t.desc}</td>
      <td>${t.cat}</td>
      <td><input type="checkbox" ${t.done?"checked":""} onchange="toggleDone('${wId}',${i},'weekly',this)"></td>
      <td><button onclick="delTask('${wId}',${i},'weekly')">x</button></td>
    </tr>`;
  });
}

/* ---------- MUTATORS ---------- */
async function addTask(){
  const desc=document.getElementById("new-task-desc").value.trim();
  if(!desc) return alert("Enter description");
  const scope=document.getElementById("new-task-scope").value;
  const signif=document.getElementById("new-task-signif").value;
  const cat=document.getElementById("new-task-cat").value;
  if(scope==="daily"){
    tasks[selDate]=tasks[selDate]||[];
    tasks[selDate].push({desc,signif,cat,done:false});
  }else{
    const wId=weekId(selDate);
    weeklyTasks[wId]=weeklyTasks[wId]||[];
    weeklyTasks[wId].push({desc,cat,done:false});
  }
  document.getElementById("new-task-desc").value="";
  await save();
  renderTaskTable();renderWeeklyTasks();
}
async function toggleDone(key,idx,scope,chk){
  if(scope==="daily"){
    const t=tasks[key][idx];
    t.done=chk.checked;
  }else{
    const t=weeklyTasks[key][idx];
    t.done=chk.checked;
  }
  await save();
  renderTaskTable();renderWeeklyTasks();
}
async function delTask(key,idx,scope){
  if(scope==="daily"){tasks[key].splice(idx,1);}
  else{weeklyTasks[key].splice(idx,1);}
  await save();renderTaskTable();renderWeeklyTasks();
}

/* ---------- BOOTSTRAP ---------- */
let selDate=fmtDate(new Date());
function initUI(){
  document.getElementById("date-today").textContent=selDate;
  renderCalendar();renderTaskTable();renderWeeklyTasks();
}
window.onload=initUI;

/* expose */
Object.assign(window,{addTask,toggleDone,delTask,changeMonth,selectDate});
</script>
</body>
</html>
