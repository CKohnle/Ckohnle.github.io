<script type="module">
  // Your web app's Firebase configuration (already present and looks correct!)
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBzCogyORUtEw8efrl8KoeAPPuK0mFQzy8",
    authDomain: "task-tracker-83250.firebaseapp.com",
    projectId: "task-tracker-83250",
    storageBucket: "task-tracker-83250.firebasestorage.app",
    messagingSenderId: "657729804454",
    appId: "1:657729804454:web:a980f2b9e7ca6108e8fc67",
    measurementId: "G-XLS1KS71VZ"
  };

  // --- Firebase SDK Imports (now v11.10.0 as per your code) ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";
  // Added Authentication and Firestore imports
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc }
    from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  // Initialize Firebase services for Auth and Firestore
  const auth = getAuth(app);
  const db = getFirestore(app);

/* ---------- CONSTANTS ---------- */
// Clearly aligned with $50/hr baseline; 1 ₱ = 1 hour of productive work
const signifRate = {
  daily: 0.2,    // ~$10/hr
  minor: 0.5,    // ~$25/hr
  major: 1,      // $50/hr baseline
  massive: 2     // $100/hr, highly impactful tasks
};

const exerciseCapHrs = 10;                                  // hard-cap per ISO week

/* ---------- STATE (Initial load from localStorage on page load) ---------- */
// These lines correctly load initial state from localStorage.
// They will be overwritten by Firebase data if a user signs in, and then re-loaded
// from localStorage after the page reloads from a Firebase sync.
let settings = JSON.parse(localStorage.getItem('settings')) ||
               {weeklyTokens:80};  // Adjusted from 600 to 80 tokens
let pointsData = JSON.parse(localStorage.getItem('pointsData')) || {current:0,totalEarned:0,totalSpent:0};
let tasks = JSON.parse(localStorage.getItem('tasks')) || {}; // keyed by date
let categories = JSON.parse(localStorage.getItem('categories')) ||
                 [{name:'General',points:0,credits:0,rewards:[]}];
let tokenUsage = JSON.parse(localStorage.getItem('tokenUsage')) || {}; // per weekId

/* ---------- HELPER DATE / WEEK ---------- */
function fmtDate(d){const m=('0'+(d.getMonth()+1)).slice(-2),dd=('0'+d.getDate()).slice(-2);return `${m}-${dd}-${d.getFullYear()}`;}
function weekId(dateStr){const [m,d,y]=dateStr.split('-').map(Number);const dt=new Date(`${y}-${m}-${d}`);dt.setHours(0,0,0,0); // ISO
  const day=(dt.getDay()+6)%7; dt.setDate(dt.getDate()-day+3); // Thursday
  const firstThu=new Date(dt.getFullYear(),0,4);const dayFirstThu=(firstThu.getDay()+6)%7;firstThu.setDate(firstThu.getDate()-dayFirstThu+3);
  const week=Math.round((dt-firstThu)/604800000)+1; return `${dt.getFullYear()}-W${('0'+week).slice(-2)}`;}

/* ---------- SELECTED DATE ---------- */
let selDate = fmtDate(new Date());
let calMonth = new Date().getMonth(), calYear = new Date().getFullYear();

/* ---------- RENDER FUNCTIONS ---------- */
function renderCalendar(){
  const first=new Date(calYear,calMonth,1), days=new Date(calYear,calMonth+1,0).getDate();
  document.getElementById('calendar-month-year').textContent=first.toLocaleString('default',{month:'long'})+' '+calYear;
  let html='<table><tr>'+['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=>`<th>${d}</th>`).join('')+'</tr><tr>';
  for(let i=0;i<first.getDay();i++)html+='<td></td>';
  for(let d=1;d<=days;d++){const cur=fmtDate(new Date(calYear,calMonth,d));
    if((first.getDay()+d-1)%7===0&&d!==1)html+='</tr><tr>';
    let style='';
    const todayFmt = fmtDate(new Date());
    if (cur === selDate && cur === todayFmt) style = 'background:linear-gradient(to bottom right,#3399ff 50%,#ff4444 50%);color:white;';
    else if (cur === selDate) style = 'background:#ff4444;color:white;';
    else if (cur === todayFmt) style = 'background:#3399ff;color:white;';
    html+=`<td style="${style}" onclick="selectDate('${cur}')">${d}</td>`;}
  html+='</tr></table>'; document.getElementById('calendar').innerHTML=html;
}
function renderTaskTable(){
  const tBody=document.getElementById('task-table');
  tBody.innerHTML=`<tr><th>Task</th><th>Signif</th><th>Cat</th><th>Ŧ/h</th><th>Done?</th><th>Del</th></tr>`;
  (tasks[selDate]||[]).forEach((t,i)=>{
    tBody.innerHTML+=`
      <tr>
        <td class="${t.done?'task-completed':''}">${t.desc}</td>
        <td>${t.signif}</td>
        <td>${t.cat}</td>
        <td>${signifRate[t.signif]}</td>
        <td><input type="checkbox" ${t.done?'checked':''} onchange="toggleDone(${i})"></td>
        <td><button onclick="delTask(${i})">x</button></td>
      </tr>`;
  });
}
function renderCategoryUI() {
  const catSel = document.getElementById('new-task-cat');
  const remSel = document.getElementById('remove-cat-select');
  const shopSel = document.getElementById('shop-cat-select');

  if (!catSel || !remSel || !shopSel) return;

  [catSel, remSel, shopSel].forEach(s => s.innerHTML = '');

  categories.forEach(c => {
    const o1 = document.createElement('option');
    o1.value = c.name;
    o1.textContent = c.name;
    catSel.appendChild(o1);

    const o2 = document.createElement('option');
    o2.value = c.name;
    o2.textContent = c.name;
    shopSel.appendChild(o2);

    if (c.name !== 'General') {
      const o3 = document.createElement('option');
      o3.value = c.name;
      o3.textContent = c.name;
      remSel.appendChild(o3);
    }
  });

  // Add progress bars for category token caps
  const prog = document.getElementById('progress-container');
  prog.innerHTML = '';

  const w = weekId(selDate);

  categories.forEach(c => {
    let spent = 0;
    for (const d in tasks) {
      if (weekId(d) === w) {
        tasks[d].forEach(t => {
          if (t.done && t.cat === c.name) spent += t.spent;
        });
      }
    }

    const cap = c.cap || 100; // default if missing
    const pct = Math.min(100, (spent / cap * 100).toFixed(1));
    const over = spent > cap ? ' style="background:#d9534f"' : '';

    prog.innerHTML += `
      <div class="progress-wrapper">
        <span class="progress-label">${c.name}</span>
        <div class="progress-bar">
          <div class="progress-fill"${over} style="width:${pct}%"></div>
          <div class="progress-text">${spent.toFixed(1)} / ${cap} Ŧ</div>
        </div>
      </div>`;
  });

  renderShop();
}
function renderShop(){
  const cat=document.getElementById('shop-cat-select').value||categories[0].name;
  document.getElementById('shop-title').textContent =
  `Reward Shop (${cat}) – ₱: ${pointsData.current.toFixed(1)} (Spent: ${pointsData.totalSpent.toFixed(1)})`;
  const list=document.getElementById('shop-list');list.innerHTML='';
  const c=categories.find(x=>x.name===cat);
  c.rewards.forEach((r,idx)=>{
    list.innerHTML+=`
      <div class="flex">
        <span style="flex:1">${r.desc} - <b>${r.cost} ₱</b></span>
        <button onclick="buyReward('${cat}',${idx})">Buy</button>
      </div>`;
  });
}
/* ---------- WEEK TOKEN BAR ---------- */
function updateTokenBar(){
  const w=weekId(selDate);
  const used=tokenUsage[w]||0; const pct=Math.min(100,(used/settings.weeklyTokens*100).toFixed(1));
  const fill=document.getElementById('token-week-fill');
  fill.style.width=pct+'%'; fill.className='token-week-fill'+(used>settings.weeklyTokens?' over':'');
  document.getElementById('token-week-label').textContent=pct+' %';
  document.getElementById('token-week-text').textContent=`Ŧ Used: ${used.toFixed(1)} / ${settings.weeklyTokens}`;
}
/* ---------- MUTATION HELPERS ---------- */
async function addTask(){ // Made async
  const desc=document.getElementById('new-task-desc').value.trim();
  const signif=document.getElementById('new-task-signif').value;
  const cat=document.getElementById('new-task-cat').value;
  if(!desc)return alert('Enter description');
  tasks[selDate]=tasks[selDate]||[];
  tasks[selDate].push({desc,signif,cat,done:false,dur:0});
  document.getElementById('new-task-desc').value='';
  await save(); // Call async save()
  renderTaskTable();
}
async function toggleDone(idx) { // Made async
  const t = tasks[selDate][idx];
  const w = weekId(selDate);

  if (!t.done) {
    const mins = parseFloat(prompt('Minutes spent?', '60'));
    if (isNaN(mins) || mins <= 0) {
      event.target.checked = false;
      return;
    }

    const hrs = mins / 60;
    const spent = signifRate[t.signif] * hrs;

    // Update token usage
    tokenUsage[w] = (tokenUsage[w] || 0) + spent;

    // Weekly token cap warning
    if (tokenUsage[w] > settings.weeklyTokens) {
      alert('⚠️ Weekly Ŧ limit exceeded!');
    }

    // Category cap check
    const catObj = categories.find(c => c.name === t.cat);
    let catSpent = 0;
    for (const d in tasks) {
      if (weekId(d) === w) {
        tasks[d].forEach(x => {
          if (x.done && x.cat === t.cat) catSpent += x.spent;
        });
      }
    }
    if (catObj && catSpent + spent > catObj.cap) { // Added null check for catObj
      alert(`⚠️ You exceeded the weekly cap for ${t.cat} (${catObj.cap} Ŧ)`);
    }

    // Special case: Exercise cap
    if (t.cat === 'Exercise') {
      const exHrs = tasksOfWeek('Exercise', w) + hrs;
      if (exHrs > exerciseCapHrs) {
        alert('Exercise cap (10 h/wk) exceeded!');
      }
    }

    pointsData.current += spent;
    pointsData.totalEarned += spent;

    t.done = true;
    t.dur = hrs;
    t.spent = spent;

  } else {
    // Undoing task completion
    tokenUsage[w] -= t.spent;
    pointsData.current -= t.spent;
    pointsData.totalEarned -= t.spent;

    t.done = false;
  }

  await save(); // Call async save()
  renderTaskTable();
  updateTokenBar();
  updatePointsDisplay();
  renderShop();
  renderCategoryUI(); // <- To update category bars too
}
async function delTask(i){ // Made async
  tasks[selDate].splice(i,1);
  await save(); // Call async save()
  renderTaskTable();
}
async function addCategory(){ // Made async
  const name = document.getElementById('new-cat-name').value.trim();
  if (!name) return;
  if (categories.some(c => c.name === name)) return alert('Exists!');
  const cap = parseFloat(prompt(`Weekly Ŧ cap for category "${name}"? (e.g. 20)`));
  if (isNaN(cap) || cap <= 0) return alert('Invalid cap amount.');
  categories.push({name,points:0,credits:0,rewards:[],cap});
  document.getElementById('new-cat-name').value='';
  await save(); // Call async save()
  renderCategoryUI();
}
async function removeCategory(){ // Made async
  const name=document.getElementById('remove-cat-select').value;if(!name)return;
  if(!confirm('Delete '+name+' ?'))return;
  categories=categories.filter(c=>c.name!==name);
  for(const d in tasks){tasks[d]=tasks[d].filter(t=>t.cat!==name);}
  await save(); // Call async save()
  renderTaskTable();
  renderCategoryUI();
}
async function addReward(){ // Made async
  const cat=document.getElementById('shop-cat-select').value;
  const desc=document.getElementById('new-reward-desc').value.trim();
  const cost=parseInt(document.getElementById('new-reward-cost').value);
  if(!desc||!cost)return alert('Need desc & cost');
  const c=categories.find(x=>x.name===cat);c.rewards.push({desc,cost});
  document.getElementById('new-reward-desc').value='';document.getElementById('new-reward-cost').value='';
  await save(); // Call async save()
  renderShop();
}
async function buyReward(cat,idx){ // Made async
  const c=categories.find(x=>x.name===cat),r=c.rewards[idx];
  if(pointsData.current<r.cost)return alert('Not enough ₱');
  if(!confirm(`Redeem "${r.desc}" for ${r.cost} ₱ ?`))return;
  pointsData.current-=r.cost;pointsData.totalSpent+=r.cost;
  await save(); // Call async save()
  updatePointsDisplay();renderShop();
  alert('Enjoy: '+r.desc+'!');
}
async function updateSettings(){ // Made async
  settings.weeklyTokens=parseInt(document.getElementById('weekly-tokens-input').value)||settings.weeklyTokens;
  await save(); // Call async save()
  updateTokenBar();
}
function updatePointsDisplay(){
  document.getElementById('points-current').textContent=pointsData.current.toFixed(1);
  document.getElementById('points-earned').textContent=pointsData.totalEarned.toFixed(1);
  document.getElementById('points-spent').textContent=pointsData.totalSpent.toFixed(1);
}

/* ---------- UTIL ---------- */
function tasksOfWeek(cat,wId){
  let hrs=0;
  for(const d in tasks)if(weekId(d)===wId)tasks[d].forEach(t=>{if(t.done&&t.cat===cat)hrs+=t.dur;});
  return hrs;
}

/* ---------- NEW SAVE FUNCTIONS (Replaced old `save()`) ---------- */
// Writes all five state objects into localStorage.
function saveLocal() {
  try {
    localStorage.setItem("settings", JSON.stringify(settings));
    localStorage.setItem("pointsData", JSON.stringify(pointsData));
    localStorage.setItem("tasks", JSON.stringify(tasks));
    localStorage.setItem("categories", JSON.stringify(categories));
    localStorage.setItem("tokenUsage", JSON.stringify(tokenUsage));
    console.log("Local state saved to localStorage.");
  } catch (e) {
    console.error("Error saving state to localStorage:", e);
  }
}

// Calls saveLocal(), then if userId is set, writes all five objects
// into Firestore under the same “trackers”/user.uid document.
async function save() {
  saveLocal(); // Always save to local storage first

  const user = auth.currentUser;
  if (user) {
    try {
      const userDocRef = doc(db, "trackers", user.uid);
      const dataToSave = {
        settings: settings,
        pointsData: pointsData,
        tasks: tasks,
        categories: categories,
        tokenUsage: tokenUsage,
        lastUpdated: new Date() // Good practice to add a timestamp!
      };
      // setDoc with { merge: true } ensures that only these fields are updated/created,
      // and other fields in the document (if any) are preserved.
      await setDoc(userDocRef, dataToSave, { merge: true });
      console.log("State saved to Firestore for user:", user.uid);
    } catch (error) {
      console.error("Error saving state to Firestore:", error);
    }
  } else {
    console.log("No user signed in. State only saved to localStorage.");
  }
}

function saveBackup(){
  const data={tasks,categories,tokenUsage,settings,pointsData};
  const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`backup_${fmtDate(new Date())}.json`;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
}
function loadBackup(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=()=>{
    const data=JSON.parse(reader.result);
    // Overwrite in-memory state variables
    tasks=data.tasks;
    categories=data.categories;
    tokenUsage=data.tokenUsage;
    settings=data.settings;
    pointsData=data.pointsData;
    saveLocal(); // Save the loaded backup to localStorage only
    location.reload();
  };
  reader.readAsText(file);
}
/* ---------- INIT ---------- */
function selectDate(d){selDate=d;document.getElementById('date-today').textContent=d;renderCalendar();renderTaskTable();updateTokenBar();renderCategoryUI();}
function changeMonth(off){calMonth+=off;if(calMonth<0){calMonth=11;calYear--;} if(calMonth>11){calMonth=0;calYear++;} renderCalendar();}
function clearAllData() {
  if (!confirm('Delete ALL local data? This will NOT delete your synced cloud data.')) return; // Improved confirmation message

  // Clear localStorage
  localStorage.clear();

  // Reset in-memory data too
  settings = { weeklyTokens: 80 };
  pointsData = { current: 0, totalEarned: 0, totalSpent: 0 };
  tasks = {};
  tokenUsage = {};
  categories = [{ name: 'General', points: 0, credits: 0, rewards: [] }];

  // No call to `save()` or `saveLocal()` here, as localStorage.clear() handles it.
  // The next page load will re-initialize `let ... = JSON.parse(localStorage.getItem...) || {}`.

  // Reload clean
  location.reload();
}

/* ---------- Firebase Authentication: Google Sign-In (from previous response) ---------- */
const loginButton = document.getElementById("login");
if (loginButton) {
  loginButton.addEventListener("click", async () => {
    const provider = new GoogleAuthProvider();
    try {
      await signInWithPopup(auth, provider);
      console.log("Successfully signed in with Google!");
      // The onAuthStateChanged listener will handle the rest (syncing and reloading)
    } catch (error) {
      console.error("Error signing in with Google:", error.message);
      if (error.code === 'auth/popup-closed-by-user') {
        alert("Sign-in process cancelled. Please try again.");
      } else {
        alert(`Sign-in failed: ${error.message}`);
      }
    }
  });
} else {
  console.warn("Login button with ID 'login' not found. Please ensure your HTML has it.");
}

/* ---------- Firebase onAuthStateChanged Listener (from previous response) ---------- */
onAuthStateChanged(auth, async (user) => {
  if (user) {
    console.log("User signed in:", user.uid);
    const userDocRef = doc(db, "trackers", user.uid);

    try {
      const docSnap = await getDoc(userDocRef);

      if (docSnap.exists()) {
        const remoteData = docSnap.data();
        console.log("Remote data found in Firestore, syncing to local:", remoteData);

        // Overwrite local variables with remote data, prioritizing what's in Firestore
        // Use `|| {}` to ensure variables are always objects even if a field is missing in Firestore
        settings = remoteData.settings || {};
        pointsData = remoteData.pointsData || {};
        tasks = remoteData.tasks || {};
        categories = remoteData.categories || {};
        tokenUsage = remoteData.tokenUsage || {};

        console.log("Local state updated with remote data from Firestore.");
        saveLocal(); // Push the now-synced data into localStorage
        window.location.reload(); // Reload the page to ensure all components reflect the new state

      } else {
        console.log("No remote data found for this user. Saving current local state to Firestore.");
        // If it's a new user or their first time syncing, save their current local state to Firestore.
        await save(); // This will call saveLocal() AND save to Firestore
        window.location.reload(); // Reload the page after saving the initial state
      }
    } catch (error) {
      console.error("Error loading user data from Firestore:", error);
      // In case of an error during Firestore read, ensure local state is still persisted.
      saveLocal();
      window.location.reload(); // Still reload to handle potential UI inconsistencies
    }
  } else {
    console.log("No user signed in. Using data from localStorage only.");
    // At this point, the initial `let var = JSON.parse(localStorage.getItem('var')) || {}`
    // has already run, so the app will use the last saved local state.
  }
});


/* ---------- BOOT ---------- */
window.onload=()=>{
  document.getElementById('weekly-tokens-input').value=settings.weeklyTokens;
  document.getElementById('date-today').textContent=selDate;
  renderCalendar();renderCategoryUI();renderTaskTable();updateTokenBar();updatePointsDisplay();renderShop();
};
</script>
